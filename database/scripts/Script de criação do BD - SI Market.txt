CREATE TABLE Usuario (
        cpf CHAR(11) NOT NULL,
        pnome VARCHAR(50) NOT NULL,
        sobrenome VARCHAR(50) NOT NULL,
        cep CHAR(8),
        email VARCHAR(150) NOT NULL,
        senha_hash TEXT NOT NULL,
        
        PRIMARY KEY (cpf),
        UNIQUE (email),
        CONSTRAINT cpf_formato CHECK (cpf ~ '^[0-9]{11}$'),
        CONSTRAINT cep_formato CHECK (cep ~ '^[0-9]{8}$'),
        CONSTRAINT EMAIL_FORMATO CHECK (email ~* '^[A-Za-z0-9][A-Za-z0-9._%+-]*@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);


CREATE TABLE Comprador (
        cpf_comprador CHAR(11) NOT NULL,
        num_compras INT DEFAULT 0,
        
        PRIMARY KEY (cpf_comprador),
        CONSTRAINT chk_comprador_num_compras CHECK (num_compras >= 0),
        CONSTRAINT fk_comprador_usuario FOREIGN KEY (cpf_comprador)
        REFERENCES usuario(cpf)                 
        ON DELETE RESTRICT ON UPDATE CASCADE
);


CREATE TABLE Vendedor (
        cpf_vendedor CHAR(11) NOT NULL,
        nome_loja VARCHAR(30) NOT NULL,
        desc_loja VARCHAR(250),
        
        PRIMARY KEY (cpf_vendedor),
        CONSTRAINT fk_vendedor_usuario FOREIGN KEY (cpf_vendedor)
        REFERENCES Usuario(cpf)                 
        ON DELETE RESTRICT ON UPDATE CASCADE
);


CREATE TABLE Categoria (
        id_categoria SERIAL NOT NULL,         
        nome_categoria VARCHAR(200) NOT NULL,         
        fk_categoria_pai INT,
        
        PRIMARY KEY (id_categoria),
        UNIQUE (nome_categoria),
        CONSTRAINT fk_categoria_pai FOREIGN KEY (fk_categoria_pai) REFERENCES categoria(id_categoria)                 
        ON DELETE SET NULL ON UPDATE CASCADE
);


CREATE TABLE Produto (
    id_produto SERIAL NOT NULL,
    nome_produto VARCHAR(100) NOT NULL,
    desc_produto TEXT,
    preco NUMERIC(10, 2) NOT NULL,
    origem VARCHAR(100),
    estoque_atual INT NOT NULL DEFAULT 0,
    alerta_estoque INT DEFAULT 0,
    
    PRIMARY KEY (id_produto),
    CONSTRAINT chk_produto_preco CHECK (preco > 0),
    CONSTRAINT chk_produto_estoque CHECK (estoque_atual >= 0),
    CONSTRAINT chk_produto_alerta CHECK (alerta_estoque >= 0)
);


-- Tabelas com FKs que referenciam as tabelas acima


CREATE TABLE Pedido (
        cpf_cliente CHAR(11),
        data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        status_pedido  VARCHAR(20) NOT NULL,
        total_produtos INT DEFAULT 0,
        total_pedido NUMERIC(10, 2) DEFAULT 0,
        
        CONSTRAINT chk_pedido_status CHECK (status_pedido IN ('pendente', 'enviado', 'entregue', 'cancelado')),
        CONSTRAINT chk_pedido_total_produtos CHECK (total_produtos >= 0),
        CONSTRAINT chk_pedido_total CHECK (total_pedido >= 0),
        PRIMARY KEY (cpf_cliente, data_pedido),
        CONSTRAINT fk_pedido_comprador
                FOREIGN KEY (cpf_cliente) REFERENCES Comprador(cpf_comprador) ON UPDATE CASCADE ON DELETE RESTRICT
);


CREATE TABLE Pagamento (
        id_pagamento SERIAL NOT NULL,         
        status_pagamento VARCHAR(50) NOT NULL, 
        valor_pago NUMERIC(10, 2) NOT NULL,
        metodo_pagamento VARCHAR(50),         
        num_parcelas INT DEFAULT 1,
        -- FK para o Vendedor (quem recebe)         
        fk_cpf_vendedor CHAR(11) NOT NULL,         
        -- FK para o Pedido (1:1)         
        fk_cpf_cliente CHAR(11) NOT NULL,         
        fk_data_pedido TIMESTAMP NOT NULL,         


        PRIMARY KEY (id_pagamento),
        CONSTRAINT chk_pagamento_status CHECK (status_pagamento IN ('pendente', 'aprovado', 'rejeitado')),
        CONSTRAINT chk_pagamento_valor CHECK (valor_pago >= 0),
        CONSTRAINT chk_pagamento_parcelas CHECK (num_parcelas >= 1),
        CONSTRAINT fk_recebimento_vendedor FOREIGN KEY (fk_cpf_vendedor) REFERENCES Vendedor(cpf_vendedor) ON UPDATE CASCADE
    ON DELETE RESTRICT,         
        CONSTRAINT fk_pagamento_pedido FOREIGN KEY (fk_cpf_cliente, fk_data_pedido) REFERENCES pedido(cpf_cliente, data_pedido) ON UPDATE CASCADE
    ON DELETE RESTRICT,        
        CONSTRAINT uq_pagamento_pedido UNIQUE (fk_cpf_cliente, fk_data_pedido)
    
);


CREATE TABLE Entrega (
        id_entrega SERIAL NOT NULL,         
        status_entrega VARCHAR(50) NOT NULL,
        metodo_entrega VARCHAR(100),         
        endereco_entrega TEXT NOT NULL,         
        data_envio TIMESTAMP,         
        data_prevista TIMESTAMP,         
        frete NUMERIC(10, 2) DEFAULT 0,
        endereco_vendedor TEXT,         
        -- FK para o Pedido (1:1)         
        fk_cpf_cliente CHAR(11) NOT NULL,         
        fk_data_pedido TIMESTAMP NOT NULL,         
        -- FK para o Vendedor (quem envia) 
        fk_cpf_vendedor CHAR(11) NOT NULL,         


        PRIMARY KEY (id_entrega),
        CONSTRAINT chk_entrega_status CHECK (status_entrega IN ('preparando', 'enviado', 'entregue', 'falha')),
        CONSTRAINT chk_entrega_frete CHECK (frete >= 0),
        CONSTRAINT fk_entrega_pedido FOREIGN KEY (fk_cpf_cliente, fk_data_pedido) REFERENCES pedido(cpf_cliente, data_pedido) ON UPDATE CASCADE
    ON DELETE RESTRICT,
        CONSTRAINT fk_entrega_vendedor FOREIGN KEY (fk_cpf_vendedor) REFERENCES vendedor(cpf_vendedor) ON UPDATE CASCADE
    ON DELETE RESTRICT,
        -- Garante a relação 1:1 com Pedido         
        CONSTRAINT uq_entrega_pedido UNIQUE (fk_cpf_cliente, fk_data_pedido)
  
);


CREATE TABLE Solicitacao (
        -- PK herdada de Pedido         
        cpf_cliente CHAR(11) NOT NULL,         
        data_pedido TIMESTAMP NOT NULL,         
        -- Chave parcial         
        data_solicitacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,         
        tipo VARCHAR(100) NOT NULL,
        status_solicitacao VARCHAR(50) NOT NULL,


        CONSTRAINT chk_solicitacao_tipo CHECK (tipo IN ('devolucao', 'troca', 'suporte', 'cancelamento')),
        CONSTRAINT chk_solicitacao_status CHECK (status_solicitacao IN ('aberta', 'em_analise', 'concluida')),
        PRIMARY KEY (cpf_cliente, data_pedido, data_solicitacao),         
        CONSTRAINT fk_solicitacao_pedido FOREIGN KEY (cpf_cliente, data_pedido) REFERENCES pedido(cpf_cliente, data_pedido)                 
        ON DELETE CASCADE ON UPDATE CASCADE
   
);


-- Tabelas de N para M


CREATE TABLE ContemProd (
        cpf_cliente CHAR(11) NOT NULL,
        data_pedido TIMESTAMP NOT NULL,
        id_produto INT NOT NULL,
        quantidade INT DEFAULT 1 NOT NULL,
        
        CONSTRAINT chk_contemprod_quantidade CHECK (quantidade >= 1),
        PRIMARY KEY (cpf_cliente, data_pedido, id_produto),
        CONSTRAINT fk_contem_pedido 
                FOREIGN KEY (cpf_cliente, data_pedido)
                           REFERENCES pedido(cpf_cliente, data_pedido)
                            ON DELETE CASCADE
                            ON UPDATE CASCADE,
        CONSTRAINT fk_contem_produto
                FOREIGN KEY (id_produto)
                        REFERENCES produto(id_produto)
                            ON DELETE CASCADE
                            ON UPDATE CASCADE
);


CREATE TABLE AssociaProd (
        cpf_cliente CHAR(11) NOT NULL,         
        data_pedido TIMESTAMP NOT NULL,         
        data_solicitacao TIMESTAMP NOT NULL,         
        id_produto INT NOT NULL,         
        -- PK composta que identifica a associação         
        PRIMARY KEY (cpf_cliente, data_pedido, data_solicitacao, id_produto),                  
        -- FK para a tabela Solicitacao         
        CONSTRAINT fk_associa_solicitacao FOREIGN KEY (cpf_cliente, data_pedido, data_solicitacao)                 
                REFERENCES Solicitacao(cpf_cliente, data_pedido, data_solicitacao)                 ON DELETE CASCADE ON UPDATE CASCADE,                  
        -- FK para a tabela Produto         
        CONSTRAINT fk_associa_produto FOREIGN KEY (id_produto)
                REFERENCES Produto(id_produto)                 
                ON DELETE CASCADE ON UPDATE CASCADE
   );


CREATE TABLE AvaliaProd (
        cpf_comprador CHAR(11) NOT NULL,         
        id_produto INT NOT NULL,         
        nota INT NOT NULL,
        
        CONSTRAINT chk_avaliaprod_nota CHECK (nota >= 1 AND nota <= 5),
        -- PK composta (um comprador avalia um produto uma vez)         
        PRIMARY KEY (cpf_comprador, id_produto),                  
        -- FK para a tabela Comprador         
        CONSTRAINT fk_avalia_comprador FOREIGN KEY (cpf_comprador)                 
                REFERENCES Comprador(cpf_comprador)                 
                ON DELETE CASCADE ON UPDATE CASCADE,                          
        -- FK para a tabela Produto         
        CONSTRAINT fk_avalia_produto FOREIGN KEY (id_produto)
                REFERENCES Produto(id_produto)                 
                ON DELETE CASCADE ON UPDATE CASCADE
   );


CREATE TABLE PrefereCat (
        cpf_comprador CHAR(11) NOT NULL,         
        id_categoria INT NOT NULL,         
        -- PK composta         
        PRIMARY KEY (cpf_comprador, id_categoria),                  
        -- FK para a tabela Comprador         
        CONSTRAINT fk_prefere_comprador FOREIGN KEY (cpf_comprador)         
        REFERENCES Comprador(cpf_comprador)                 
        ON DELETE CASCADE ON UPDATE CASCADE,                  
        -- FK para a tabela Categoria         
        CONSTRAINT fk_prefere_categoria FOREIGN KEY (id_categoria) 
        REFERENCES Categoria(id_categoria)                 
        ON DELETE CASCADE ON UPDATE CASCADE
        
   );


CREATE TABLE PertenceCat (
        id_categoria INT NOT NULL,         
        id_produto INT NOT NULL,         
        -- PK composta         
        PRIMARY KEY (id_categoria, id_produto),                  
        -- FK para a tabela Categoria         
        CONSTRAINT fk_pertence_categoria FOREIGN KEY (id_categoria) 
        REFERENCES Categoria(id_categoria)                 
        ON DELETE CASCADE ON UPDATE CASCADE,                          
        -- FK para a tabela Produto         
        CONSTRAINT fk_pertence_produto FOREIGN KEY (id_produto)
        REFERENCES Produto(id_produto)                 
        ON DELETE CASCADE ON UPDATE CASCADE
   );


CREATE TABLE VendeProd (
        cpf_vendedor CHAR(11) NOT NULL,
        id_produto INT NOT NULL,
        PRIMARY KEY (cpf_vendedor, id_produto),
        CONSTRAINT fk_vende_vendedor
                FOREIGN KEY (cpf_vendedor) 
        REFERENCES Vendedor(cpf_vendedor) 
        ON DELETE CASCADE ON UPDATE CASCADE,
        CONSTRAINT fk_vende_produto
                FOREIGN KEY (id_produto) 
        REFERENCES Produto(id_produto) 
        ON UPDATE CASCADE ON DELETE CASCADE
   );